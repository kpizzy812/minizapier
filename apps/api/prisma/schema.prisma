// Prisma schema for MiniZapier

generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// Workflow - main entity
model Workflow {
  id          String   @id @default(cuid())
  userId      String   // Supabase auth.users.id
  name        String
  description String?
  definition  Json     // {nodes: [...], edges: [...], variables: {...}}
  sampleData  Json?    // Sample data from last test run for Data Picker
  isActive    Boolean  @default(false)
  version     Int      @default(1)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  trigger    Trigger?
  executions Execution[]

  @@index([userId])
}

// Credentials storage (encrypted secrets)
enum CredentialType {
  TELEGRAM
  SMTP
  HTTP_BASIC
  HTTP_BEARER
  HTTP_API_KEY
  DATABASE
  RESEND
}

model Credential {
  id        String         @id @default(cuid())
  userId    String         // Supabase auth.users.id
  name      String         // "My Telegram Bot"
  type      CredentialType
  data      String         // AES-256-GCM encrypted JSON
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt

  @@index([userId])
}

// Trigger types
enum TriggerType {
  WEBHOOK
  SCHEDULE
  EMAIL
}

model Trigger {
  id         String      @id @default(cuid())
  type       TriggerType
  config     Json        // webhook: {secret}, schedule: {cron}, email: {address}
  webhookUrl String?     @unique // Unique URL for webhook
  workflowId String      @unique
  workflow   Workflow    @relation(fields: [workflowId], references: [id], onDelete: Cascade)
}

// Execution status
enum ExecutionStatus {
  PENDING
  RUNNING
  SUCCESS
  FAILED
  PAUSED
}

model Execution {
  id         String          @id @default(cuid())
  workflowId String
  workflow   Workflow        @relation(fields: [workflowId], references: [id], onDelete: Cascade)
  status     ExecutionStatus @default(PENDING)
  startedAt  DateTime        @default(now())
  finishedAt DateTime?
  input      Json?           // Trigger input data
  output     Json?           // Final result
  error      String?         // Error message if FAILED

  steps StepLog[]

  @@index([workflowId, startedAt])
}

// Step execution log
model StepLog {
  id          String    @id @default(cuid())
  executionId String
  execution   Execution @relation(fields: [executionId], references: [id], onDelete: Cascade)
  nodeId      String    // Node ID from React Flow
  nodeName    String    // Display name
  status      String    // pending, running, success, error, skipped
  input       Json?
  output      Json?
  error       String?
  duration    Int?      // Duration in ms
  createdAt   DateTime  @default(now())

  @@index([executionId, createdAt])
}
